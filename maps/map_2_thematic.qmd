---
title: "DigiKat Map 2: Thematic Structure"
subtitle: "What is Croatian Catholic Digital Media About?"
author: "DigiKat Project"
date: today
format:
  html:
    toc: true
    toc-depth: 3
    toc-location: left
    number-sections: true
    code-fold: true
    code-summary: "Show code"
    theme: cosmo
    fig-width: 10
    fig-height: 6
execute:
  warning: false
  message: false
---

```{r setup}
#| label: setup
#| include: false

# ============================================================================
# CONFIGURATION - ADJUST THESE PARAMETERS
# ============================================================================
SAMPLE_PCT <- 0.01
NUM_TOPICS <- 35
# ============================================================================

library(tidyverse)
library(data.table)
library(scales)
library(ggplot2)
library(knitr)
library(kableExtra)
library(text2vec)
library(quanteda)
library(quanteda.textstats)
library(quanteda.textplots)
library(stm)
library(tidytext)
library(ggrepel)
library(viridis)
library(pheatmap)
library(RColorBrewer)

theme_set(theme_minimal(base_size = 12) +
          theme(
            plot.title = element_text(face = "bold", size = 14),
            plot.subtitle = element_text(color = "gray40"),
            legend.position = "bottom"
          ))

platform_colors <- c(
  "web" = "#4285F4",
  "facebook" = "#1877F2", 
  "instagram" = "#E4405F",
  "youtube" = "#FF0000",
  "twitter" = "#1DA1F2",
  "forum" = "#FF6600",
  "reddit" = "#FF4500",
  "comment" = "#808080"
)

actor_colors <- c(
  "Institutional Official" = "#1a3c5a",
  "Diocesan" = "#2c5f7c",
  "Independent Media" = "#4a9c6d",
  "Individual Priests" = "#e07b39",
  "Charismatic Communities" = "#c44536",
  "Religious Orders" = "#6b4c9a",
  "Youth Organizations" = "#eab308",
  "Academic" = "#64748b",
  "Lay Influencers" = "#ec4899",
  "Other" = "#94a3b8"
)

topic_category_colors <- c(
  "Liturgical/Sacramental" = "#7b3294",
  "Devotional" = "#c2a5cf",
  "Institutional" = "#008837",
  "Social/Ethical" = "#a6dba0",
  "Political" = "#d7191c",
  "Youth/Community" = "#fdae61",
  "Educational" = "#2c7bb6"
)
```

# Introduction

This document presents **Map 2: Thematic Structure** of the DigiKat project. The core question driving this analysis is: **What is Croatian Catholic digital media about, and who specializes in what?**

We use topic modeling to discover the thematic landscape of the corpus and then examine how different actors and platforms specialize in particular topics.

```{r load-data}
#| label: load-data

dta <- readRDS("C:/Users/lsikic/Luka C/HKS/Projekti/Digitalni Kat/SHKM/DigiKat/data/merged_comprehensive.rds") %>%
  filter(SOURCE_TYPE != "tiktok", !is.na(SOURCE_TYPE)) %>%
  filter(DATE >= as.Date("2021-01-01") & DATE <= as.Date("2024-12-31")) %>%
  filter(year >= 2021 & year <= 2024)
setDT(dta)

# Check data loaded correctly
cat("Data loaded:", nrow(dta), "rows\n")
if (nrow(dta) == 0) stop("No data after filtering! Check your date filters.")

n_posts <- nrow(dta)
n_with_text <- sum(!is.na(dta$FULL_TEXT) & nchar(dta$FULL_TEXT) > 50, na.rm = TRUE)
```

```{r actor-classification}
#| label: actor-classification

secular_media_exclusions <- c(
  "slobodnadalmacija", "vecernji", "index.hr", "jutarnji", "novilist",
  "24sata", "direktno.hr", "nacional", "tportal", "dnevnik.hr", "hrt.hr",
  "n1info", "rtl.hr", "net.hr", "telegram.hr", "story.hr", "forum.hr",
  "glasistre", "dnevno.hr", "prigorski", "glas-slavonije", "croativ",
  "oluja.info", "maxportal", "hkv.hr", "icv.hr", "novosti.hr", "7dnevno",
  "mnovine", "sjever.hr", "dulist.hr", "pozega.eu", "sibenik.in",
  "ferata.hr", "epodravina", "glasgacke", "radio-zlatar", "medjimurski.hr",
  "sbperiskop", "zagorje-international", "pozeski", "novine.hr",
  "dubrovnikinsider", "regionalni", "leportale", "varazdinske-vijesti",
  "radionasice", "brodportal", "ljportal", "dubrovnikportal", "01portal",
  "tomislavnews", "hia.com.hr", "portalnovosti", "antenazadar",
  "dalmacijanews", "zadarskilist", "medjimurjepress",
  "zagreb.info", "034portal", "057info", "inmemoriam", "magicus.info",
  "book.hr", "mojzagreb.info", "skole.hr", "tvprofil", "cityportal",
  "klikaj.hr", "lika-online", "priznajem.hr", "ploce.com",
  "dragovoljac.com", "sbonline", "narod.hr", "infokiosk", "hrsvijet",
  "tomislavcity", "vrisak.info", "croatia", "anonymous_user", "reddit",
  "dalmacijadanas"
)

classify_actor_v2 <- function(from_value, url_value = NA) {
  from_lower <- tolower(from_value)
  url_lower <- tolower(ifelse(is.na(url_value), "", url_value))
  
  if (any(sapply(secular_media_exclusions, function(x) grepl(x, from_lower, fixed = TRUE)))) {
    return("Other")
  }
  
  institutional_domains <- c("hkm.hr", "ika.hkm.hr", "hkr.hkm.hr", "hbk.hr")
  if (any(sapply(institutional_domains, function(x) grepl(x, url_lower, fixed = TRUE)))) {
    return("Institutional Official")
  }
  
  institutional_names <- c(
    "hrvatska katolička mreža", "katolička mreža", "hkm", 
    "informativna katolička agencija", "ika", "hrvatski katolički radio", "hkr",
    "hrvatska biskupska konferencija", "hbk"
  )
  if (any(sapply(institutional_names, function(x) grepl(x, from_lower, fixed = TRUE)))) {
    return("Institutional Official")
  }
  
  diocesan_domains <- c(
    "zg-nadbiskupija.hr", "biskupija-varazdinska.hr", "djos.hr", 
    "biskupija-sj.hr", "rzs.hr", "rkc-sisak.hr", "zadarskanadbiskupija.hr",
    "gospicko-senjska-biskupija.hr", "nadbiskupija-split.com",
    "dubrovacka-biskupija.hr", "porec-biskupija.hr", "biskupija-kk.hr"
  )
  if (any(sapply(diocesan_domains, function(x) grepl(x, url_lower, fixed = TRUE)))) {
    return("Diocesan")
  }
  
  diocesan_names <- c(
    "nadbiskupija", "biskupija", "župa ", "zupa ", 
    "zagrebačka nadbiskupija", "splitsko-makarska", "đakovačko-osječka",
    "riječka nadbiskupija", "zadarska nadbiskupija", "sisačka biskupija",
    "varaždinska biskupija", "križevačka eparhija"
  )
  if (any(sapply(diocesan_names, function(x) grepl(x, from_lower, fixed = TRUE)))) {
    return("Diocesan")
  }
  
  independent_media_exact <- c(
    "laudatotv", "laudato tv", "laudato.tv", "laudato.hr",
    "bitno.net", "bitno net", "glas koncila", "glaskoncila.hr",
    "nova-eva.com", "nova eva", "katolički tjednik", "katolicki tjednik",
    "kršćanska sadašnjost", "ks.hr", "verbum.hr", "verbum",
    "mir i dobro", "gfranciskovic", "kfranciskovic", "totus tuus"
  )
  if (any(sapply(independent_media_exact, function(x) grepl(x, from_lower, fixed = TRUE)))) {
    return("Independent Media")
  }
  
  independent_media_domains <- c(
    "laudato.hr", "laudato.tv", "bitno.net", "glaskoncila.hr", 
    "nova-eva.com", "verbum.hr", "ks.hr"
  )
  if (any(sapply(independent_media_domains, function(x) grepl(x, url_lower, fixed = TRUE)))) {
    return("Independent Media")
  }
  
  religious_orders_exact <- c(
    "franjevci", "franjevački", "franjevacki", "ofm",
    "isusovci", "družba isusova", "druzba isusova", "sj",
    "dominikanci", "dominikanski", "op",
    "salezijanci", "salezijanski", "sdb",
    "karmelićani", "karmelicani", "karmel",
    "benediktinci", "benediktinski", "osb",
    "kapucini", "kapucinski", "ofmcap",
    "pavlini", "pavlinski",
    "trapisti", "cisterciti",
    "sestre milosrdnice", "uršulinke", "klarise"
  )
  if (any(sapply(religious_orders_exact, function(x) grepl(x, from_lower, fixed = TRUE)))) {
    return("Religious Orders")
  }
  
  charismatic_exact <- c(
    "božja pobjeda", "bozja pobjeda", "bozjapobjeda",
    "srce isusovo", "srceisuovo", "srceisusovo",
    "muževni budite", "muzevni budite", "muzevnibudite",
    "molitvena zajednica", "karizmatska", "cenacolo",
    "emmanuel community", "emmanuel zajednica", "taize",
    "neokatekumenski", "neokatekumenska", "kursiljo",
    "fokolari", "fokolarini", "komunija i oslobođenje"
  )
  if (any(sapply(charismatic_exact, function(x) grepl(x, from_lower, fixed = TRUE)))) {
    return("Charismatic Communities")
  }
  
  priest_patterns <- c(
    "fra ", "don ", "vlč.", "vlc.", "msgr.", "mons.",
    "padre ", "o. ", "pater ", "biskup ", "nadbiskup ",
    "kardinal ", "svećenik", "svecenik"
  )
  if (any(sapply(priest_patterns, function(x) grepl(x, from_lower, fixed = TRUE)))) {
    return("Individual Priests")
  }
  
  youth_exact <- c(
    "frama", "shkm", "katolička mladež", "katolicka mladez",
    "ministranti", "mladifra", "mladi fra", "kaem", "kud",
    "sveučilišna kapelanija", "studentska kapelanija"
  )
  if (any(sapply(youth_exact, function(x) grepl(x, from_lower, fixed = TRUE)))) {
    return("Youth Organizations")
  }
  
  academic_exact <- c(
    "unicath", "katolički bogoslovni fakultet", "kbf",
    "teologija", "filozofski fakultet družbe isusove", "hks.hr",
    "hrvatsko katoličko sveučilište", "hku"
  )
  if (any(sapply(academic_exact, function(x) grepl(x, from_lower, fixed = TRUE)))) {
    return("Academic")
  }
  
  lay_influencer_patterns <- c(
    "vjera", "molitva", "isus", "krist", "gospa", "marija",
    "hrana za dušu", "hrana za dusu", "dijete vjere",
    "pulherissimus", "riječ", "rijec", "katolik",
    "kršćan", "krscan", "evanđelje", "evandelje",
    "duhovn", "svetac", "sveci", "biblij", "psalm",
    "blagoslov", "nebo", "spasenje", "uskrs", "božić", "bozic"
  )
  
  is_social_media <- grepl("facebook\\.com|youtube\\.com|instagram\\.com", url_lower) |
                     !grepl("\\.", from_lower)
  
  if (is_social_media && any(sapply(lay_influencer_patterns, function(x) grepl(x, from_lower, fixed = TRUE)))) {
    return("Lay Influencers")
  }
  
  return("Other")
}

dta[, ACTOR_TYPE := mapply(classify_actor_v2, FROM, URL)]
```

## Corpus Overview

```{r corpus-overview}
#| label: corpus-overview

tibble(
  Metric = c("Total posts", "Posts with sufficient text (>50 chars)", "Unique sources", 
             "Date range", "Platforms"),
  Value = c(
    format(n_posts, big.mark = ","),
    format(n_with_text, big.mark = ","),
    format(uniqueN(dta$FROM), big.mark = ","),
    paste(min(dta$DATE), "to", max(dta$DATE)),
    paste(unique(dta$SOURCE_TYPE), collapse = ", ")
  )
) %>%
  kable(col.names = c("Metric", "Value")) %>%
  kable_styling(bootstrap_options = c("striped", "hover"), full_width = FALSE)
```

# Analysis 2.1: Topic Discovery

We use Structural Topic Modeling (STM) which allows incorporating document metadata as covariates. The analysis uses Croatian text preprocessing with custom stopwords.

```{r text-preprocessing}
#| label: text-preprocessing

croatian_stopwords <- unique(c(
  # --- CONJUNCTIONS (Veznici) ---
  "i", "pa", "te", "ni", "niti", "a", "ali", "nego", "no", "već", "vec",
  "ili", "da", "dok", "jer", "ako", "mada", "premda", "iako", "kako",
  "neka", "kad", "kada", "cim", "čim", "zato",

  # --- PREPOSITIONS (Prijedlozi) ---
  "u", "na", "s", "sa", "o", "po", "za", "uz", "iz", "do", "od", "pri",
  "k", "ka", "bez", "blizu", "osim", "među", "medju", "poput", "putem",
  "prema", "pored", "pokraj", "kroz", "nad", "pod", "pred", "oko", "okolo",
  "niz", "uzduž", "duž", "vrh", "dno", "kraj", "krajem", "usprkos", "glede",
  "nasuprot", "ispod", "iznad", "između", "izmedju", "iza", "unutar", "van",

  # --- AUXILIARY VERBS & "BITI" (To Be) ---
  # Present
  "sam", "si", "je", "smo", "ste", "su", "jesam", "jesi", "jest", "jesmo", "jeste", "jesu",
  "budem", "budeš", "budes", "bude", "budemo", "budete", "budu",
  # Past
  "bio", "bila", "bilo", "bili", "bile",
  # Negative
  "nisam", "nisi", "nije", "nismo", "niste", "nisu",
  "ne", "nemoj",
  # Infinitive
  "biti", "bit",

  # --- VERBS "HTJETI" (Will/Want) ---
  "ću", "cu", "ćeš", "ces", "će", "ce", "ćemo", "cemo", "ćete", "cete",
  "hoću", "hocu", "hoćeš", "hoces", "hoće", "hoce", "hoćemo", "hocemo", "hoćete", "hocete", "hoće", "hoce",
  "bih", "bi", "bismo", "biste", "htio", "htjela", "htjelo", "htjeli", "htjele",
  "neću", "necu", "nećeš", "neces", "neće", "nece", "nećemo", "necemo", "nećete", "necete", "neće", "nece",

  # --- VERBS "MOĆI" & "IMATI" (Can/Have) ---
  "mogu", "možeš", "mozes", "može", "moze", "možemo", "mozemo", "možete", "mozete",
  "mogao", "mogla", "moglo", "mogli", "mogle", "moći", "moci",
  "imam", "imaš", "imas", "ima", "imamo", "imate", "imaju", "imao", "imala", "imalo", "imali", "imati",

  # --- PRONOUNS: 1st Person (Ja, Mi) - All Cases ---
  "ja", "mene", "meni", "me", "mnom", "mnome",
  "mi", "nas", "nama", "nam", "nama",

  # --- PRONOUNS: 2nd Person (Ti, Vi) - All Cases ---
  "ti", "tebe", "tebi", "te", "tobom", "tobome",
  "vi", "vas", "vama", "vam",

  # --- PRONOUNS: 3rd Person (On, Ona, Ono, Oni) - All Cases ---
  "on", "njega", "njemu", "ga", "nj", "njim", "njime",
  "ona", "nje", "njoj", "ju", "je", "njom", "njome",
  "ono",
  "oni", "one", "ona", "njih", "njima", "ih",

  # --- PRONOUNS: Reflexive (Sebe) ---
  "sebe", "sebi", "se", "sobom",

  # --- DETERMINERS & POSSESSIVES (This, That, My, Your...) ---
  # Only high frequency variations included to prevent list bloat
  "taj", "ta", "to", "tog", "toga", "tom", "tome", "tomu", "tim", "tima", "toj", "te",
  "ovaj", "ova", "ovo", "ovog", "ovoga", "ovom", "ovome", "ovim", "ovima", "ovoj", "ove",
  "onaj", "ona", "ono", "onog", "onoga", "onom", "onome", "onim", "onima", "onoj", "one",
  "moj", "moja", "moje", "mojeg", "mojega", "mom", "mome", "mojem", "mojemu", "mojim", "mojima", "mojih",
  "tvoj", "tvoja", "tvoje", "tvojeg", "tvojim",
  "naš", "nas", "naša", "nasa", "naše", "nase", "našeg", "naseg", "našem", "nasem", "našim", "nasim",
  "vaš", "vas", "vaša", "vasa", "vaše", "vase", "vašeg", "vaseg", "vašem", "vasem", "vašim", "vasim",
  "njegov", "njegova", "njegovo", "njen", "njezin", "njihov", "njihova", "njihovo",

  # --- RELATIVE PRONOUNS / QUESTION WORDS ---
  "tko", "što", "sto", "kog", "koga", "kom", "kome", "čemu", "cemu", "čim", "cim", "čime", "cime",
  "koji", "koja", "koje", "kojeg", "kojega", "kojem", "kojemu", "kojim", "kojima", "kojih",
  "kakav", "kakva", "kakvo", "svaki", "svaka", "svako", "sva", "sve", "svi", "svih", "svima",
  "neki", "neka", "neko", "nekog", "nekom", "nekim",
  "sav", "sva", "sve",
  "netko", "nešto", "nesto", "nitko", "ništa", "nista", "svatko",

  # --- ADVERBS & PARTICLES (Prilozi i čestice) ---
  "gdje", "kamo", "kuda", "odakle", "kako", "zašto", "zasto",
  "ovdje", "tamo", "tu", "negdje", "nigdje",
  "jučer", "jucer", "danas", "sutra", "sada", "sad", "tada", "onda", "uvijek", "nikad", "nikada",
  "mnogo", "puno", "malo", "više", "vise", "manje",
  "jako", "vrlo", "baš", "bas", "čak", "cak",
  "dakle", "međutim", "medjutim", "naprosto", "naime", "vjerojatno", "naravno", "sigurno", "zaista", "doista",

  # --- NUMBERS (Common in text) ---
  "jedan", "jedna", "jedno", "dva", "tri", "četiri", "cetiri", "pet", "šest", "sest", "sedam", "osam", "devet", "deset",
  "prvi", "prva", "prvo", "drugi", "druga", "drugo", "treći", "treci",

  # --- TECH / WEB NOISE ---
  "http", "https", "www", "com", "hr", "org", "net", "foto", "video", "slika", "clanak", "članak"
))


dta_text <- dta[!is.na(FULL_TEXT) & nchar(FULL_TEXT) > 100]

set.seed(42)

# Use SAMPLE_PCT from config (set at top of file)
sample_size <- ceiling(nrow(dta_text) * SAMPLE_PCT)
sample_idx <- sample(1:nrow(dta_text), sample_size)
dta_sample <- dta_text[sample_idx]

cat("
╔══════════════════════════════════════════════════════════════════╗
║  SAMPLING CONFIGURATION                                          ║
╠══════════════════════════════════════════════════════════════════╣
║  Sample percentage:", sprintf("%5.1f%%", SAMPLE_PCT * 100), "
║  Documents sampled:", sprintf("%6d", nrow(dta_sample)), "
║  Total available:  ", sprintf("%6d", nrow(dta_text)), "
╚══════════════════════════════════════════════════════════════════╝
")

dta_sample[, doc_id := .I]
dta_sample[, clean_text := FULL_TEXT]
dta_sample[, clean_text := gsub("https?://\\S+", "", clean_text)]
dta_sample[, clean_text := gsub("www\\.\\S+", "", clean_text)]
dta_sample[, clean_text := gsub("[^[:alpha:][:space:]]", " ", clean_text)]
dta_sample[, clean_text := tolower(clean_text)]
dta_sample[, clean_text := gsub("\\s+", " ", clean_text)]
dta_sample[, clean_text := trimws(clean_text)]
```

```{r create-dfm}
#| label: create-dfm

corpus_cath <- corpus(dta_sample, text_field = "clean_text", docid_field = "doc_id")

docvars(corpus_cath, "actor_type") <- dta_sample$ACTOR_TYPE
docvars(corpus_cath, "platform") <- dta_sample$SOURCE_TYPE
docvars(corpus_cath, "year") <- dta_sample$year

tokens_cath <- tokens(corpus_cath, 
                      remove_punct = TRUE,
                      remove_numbers = TRUE,
                      remove_symbols = TRUE) %>%
  tokens_tolower() %>%
  tokens_remove(pattern = croatian_stopwords) %>%
  tokens_remove(pattern = stopwords("en")) %>%
  tokens_keep(min_nchar = 3)

dfm_cath <- dfm(tokens_cath) %>%
  dfm_trim(min_termfreq = 10, min_docfreq = 5)

cat("Documents:", ndoc(dfm_cath), "\n")
cat("Features:", nfeat(dfm_cath), "\n")
```

```{r stm-model}
#| label: stm-model
#| cache: true

# Safety checks before running STM
if (ndoc(dfm_cath) == 0) {
  stop("DFM has 0 documents! Check your data loading and filtering steps.")
}
if (nfeat(dfm_cath) == 0) {
  stop("DFM has 0 features! Check your text preprocessing and trimming parameters.")
}
if (ndoc(dfm_cath) < 100) {
  warning("Very few documents (", ndoc(dfm_cath), "). Results may be unreliable.")
}

stm_dfm <- convert(dfm_cath, to = "stm")

# Verify conversion worked
if (length(stm_dfm$documents) == 0) {
  stop("STM conversion resulted in 0 documents!")
}

# Use NUM_TOPICS from config (set at top of file)
K <- NUM_TOPICS

# Adjust K if we have too few documents
if (length(stm_dfm$documents) < K * 3) {
  K <- max(5, floor(length(stm_dfm$documents) / 3))
  warning("Reduced K to ", K, " due to small corpus size")
}

stm_model <- stm(
  documents = stm_dfm$documents,
  vocab = stm_dfm$vocab,
  K = K,
  prevalence = ~ actor_type + platform,
  data = stm_dfm$meta,
  init.type = "Spectral",
  max.em.its = 50,
  verbose = TRUE,
  seed = 42
)

cat("STM model fitted with", K, "topics\n")
```

## Topic Labels and Top Words

```{r topic-words}
#| label: topic-words

topic_words <- labelTopics(stm_model, n = 10)

topic_df <- data.frame(
  Topic = 1:K,
  Top_Words = apply(topic_words$prob, 1, paste, collapse = ", "),
  FREX_Words = apply(topic_words$frex, 1, paste, collapse = ", ")
)

topic_df %>%
  kable(col.names = c("Topic", "Top Words (Probability)", "FREX Words (Distinctive)")) %>%
  kable_styling(bootstrap_options = c("striped", "hover"), full_width = TRUE) %>%
  scroll_box(height = "600px")
```

## Topic Prevalence Overview

```{r topic-prevalence}
#| label: topic-prevalence
#| fig-height: 10

topic_proportions <- colMeans(stm_model$theta)

topic_prev_df <- data.frame(
  Topic = factor(1:K),
  Prevalence = topic_proportions * 100
) %>%
  arrange(desc(Prevalence)) %>%
  mutate(Topic = factor(Topic, levels = Topic))

ggplot(topic_prev_df, aes(x = Topic, y = Prevalence)) +
  geom_col(fill = "#2c5f7c", width = 0.7) +
  geom_text(aes(label = sprintf("%.1f%%", Prevalence)), 
            hjust = -0.1, size = 3) +
  coord_flip() +
  scale_y_continuous(limits = c(0, max(topic_prev_df$Prevalence) * 1.15),
                     labels = function(x) paste0(x, "%")) +
  labs(
    title = "Topic Prevalence in Corpus",
    subtitle = paste("Distribution across", K, "topics"),
    x = "Topic",
    y = "Prevalence (%)"
  )
```

## Topic Word Clouds

```{r topic-wordclouds}
#| label: topic-wordclouds
#| fig-height: 12
#| fig-width: 14

par(mfrow = c(5, 7), mar = c(0.5, 0.5, 1.5, 0.5))

for (i in 1:K) {
  cloud(stm_model, topic = i, max.words = 30, 
        colors = brewer.pal(8, "Dark2"),
        main = paste("Topic", i))
}

par(mfrow = c(1, 1))
```

# Analysis 2.2: Topic Taxonomy

Group discovered topics into higher order thematic categories based on manual inspection of top words.

```{r topic-taxonomy}
#| label: topic-taxonomy

topic_taxonomy <- data.frame(
  Topic = 1:K,
  stringsAsFactors = FALSE
)

topic_taxonomy$Category <- NA
topic_taxonomy$Label <- NA

topic_words_list <- lapply(1:K, function(i) {
  c(topic_words$prob[i, ], topic_words$frex[i, ])
})

liturgical_keywords <- c("misa", "mise", "nedjelja", "svetkovina", "liturgi", 
                         "sakrament", "euharistij", "krizm", "krst", "pričest",
                         "uskrs", "božić", "advent", "korizma", "vazmeni")
devotional_keywords <- c("molitva", "molit", "gospa", "marij", "svetac", "sveti",
                         "duhov", "vjera", "krist", "isus", "srce", "ljubav",
                         "blagoslov", "zahval")
institutional_keywords <- c("biskupij", "nadbiskup", "biskup", "papa", "vatikan",
                            "hbk", "kardinal", "dekret", "imenovan", "župnik")
social_keywords <- c("obitelj", "život", "djeca", "brak", "pobačaj", "caritas",
                     "siromašn", "pomoć", "društv", "socijal", "rad", "posao")
political_keywords <- c("vlada", "izborn", "politič", "zakon", "država", "nacija",
                        "hrvat", "rat", "povijes", "domovina", "domoljub")
youth_keywords <- c("mladi", "škola", "student", "frama", "shkm", "ministran",
                    "kamp", "susret", "zajednic", "program", "aktivnost")
educational_keywords <- c("kateh", "teolog", "biblij", "evanđelj", "pouka",
                          "učenj", "knjiga", "čitanj", "znanje", "obrazov")

assign_category <- function(words, topic_num) {
  words_str <- tolower(paste(words, collapse = " "))
  
  scores <- c(
    Liturgical = sum(sapply(liturgical_keywords, function(k) grepl(k, words_str))),
    Devotional = sum(sapply(devotional_keywords, function(k) grepl(k, words_str))),
    Institutional = sum(sapply(institutional_keywords, function(k) grepl(k, words_str))),
    "Social/Ethical" = sum(sapply(social_keywords, function(k) grepl(k, words_str))),
    Political = sum(sapply(political_keywords, function(k) grepl(k, words_str))),
    "Youth/Community" = sum(sapply(youth_keywords, function(k) grepl(k, words_str))),
    Educational = sum(sapply(educational_keywords, function(k) grepl(k, words_str)))
  )
  
  if (max(scores) == 0) return("Other")
  names(which.max(scores))
}

for (i in 1:K) {
  topic_taxonomy$Category[i] <- assign_category(topic_words_list[[i]], i)
  topic_taxonomy$Label[i] <- paste0("Topic ", i, ": ", 
                                     paste(topic_words$frex[i, 1:3], collapse = ", "))
}

topic_taxonomy %>%
  arrange(Category, Topic) %>%
  left_join(topic_prev_df %>% select(Topic, Prevalence) %>% 
              mutate(Topic = as.numeric(as.character(Topic))), by = "Topic") %>%
  kable(col.names = c("Topic", "Category", "Label", "Prevalence (%)")) %>%
  kable_styling(bootstrap_options = c("striped", "hover"), full_width = FALSE) %>%
  scroll_box(height = "500px")
```

## Category Distribution

```{r category-distribution}
#| label: category-distribution
#| fig-height: 7

category_prevalence <- topic_taxonomy %>%
  left_join(topic_prev_df %>% 
              mutate(Topic = as.numeric(as.character(Topic))), by = "Topic") %>%
  group_by(Category) %>%
  summarise(
    Topics = n(),
    Total_Prevalence = sum(Prevalence, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  arrange(desc(Total_Prevalence))

ggplot(category_prevalence, aes(x = reorder(Category, Total_Prevalence), 
                                 y = Total_Prevalence, fill = Category)) +
  geom_col(width = 0.7) +
  geom_text(aes(label = sprintf("%.1f%%\n(%d topics)", Total_Prevalence, Topics)),
            hjust = -0.1, size = 3.5) +
  coord_flip() +
  scale_fill_brewer(palette = "Set2") +
  scale_y_continuous(limits = c(0, max(category_prevalence$Total_Prevalence) * 1.25),
                     labels = function(x) paste0(x, "%")) +
  labs(
    title = "Thematic Category Distribution",
    subtitle = "Aggregated prevalence by topic category",
    x = NULL,
    y = "Total Prevalence (%)"
  ) +
  theme(legend.position = "none")
```

# Analysis 2.3: Topic by Actor Mapping

Examine how different actor types specialize in particular topics.

```{r topic-actor-prep}
#| label: topic-actor-prep

doc_topics <- stm_model$theta
colnames(doc_topics) <- paste0("Topic_", 1:K)

doc_meta <- stm_dfm$meta
doc_meta <- cbind(doc_meta, doc_topics)

actor_topic_means <- doc_meta %>%
  group_by(actor_type) %>%
  summarise(across(starts_with("Topic_"), mean, na.rm = TRUE), .groups = "drop")

actor_topic_long <- actor_topic_means %>%
  pivot_longer(cols = starts_with("Topic_"),
               names_to = "Topic",
               values_to = "Proportion") %>%
  mutate(Topic_Num = as.numeric(gsub("Topic_", "", Topic)))
```

## Topic Proportions by Actor Type Heatmap

```{r actor-topic-heatmap}
#| label: actor-topic-heatmap
#| fig-height: 10
#| fig-width: 12

actor_topic_matrix <- actor_topic_means %>%
  column_to_rownames("actor_type") %>%
  as.matrix()

colnames(actor_topic_matrix) <- 1:K

topic_annotations <- topic_taxonomy %>%
  select(Topic, Category) %>%
  mutate(Topic = as.character(Topic)) %>%
  column_to_rownames("Topic")

pheatmap(
  t(actor_topic_matrix) * 100,
  cluster_rows = TRUE,
  cluster_cols = TRUE,
  color = colorRampPalette(c("white", "#2c5f7c", "#1a3c5a"))(100),
  main = "Topic Proportions by Actor Type (%)",
  fontsize = 10,
  fontsize_row = 8,
  fontsize_col = 9,
  angle_col = 45,
  display_numbers = FALSE,
  border_color = "grey90"
)
```

## Actor Specialization Index

Calculate how specialized each actor type is compared to corpus average.

```{r actor-specialization}
#| label: actor-specialization
#| fig-height: 8

corpus_avg <- colMeans(doc_topics)

specialization_df <- actor_topic_long %>%
  left_join(tibble(Topic_Num = 1:K, Corpus_Avg = corpus_avg), by = "Topic_Num") %>%
  mutate(
    Lift = Proportion / Corpus_Avg,
    Log_Lift = log2(Lift)
  ) %>%
  left_join(topic_taxonomy %>% select(Topic, Category, Label) %>%
              rename(Topic_Num = Topic), by = "Topic_Num")

top_specializations <- specialization_df %>%
  filter(is.finite(Log_Lift)) %>%
  group_by(actor_type) %>%
  slice_max(Log_Lift, n = 3) %>%
  ungroup()

top_specializations %>%
  select(actor_type, Label, Category, Lift) %>%
  mutate(Lift = sprintf("%.2fx", Lift)) %>%
  arrange(actor_type) %>%
  kable(col.names = c("Actor Type", "Topic", "Category", "Lift vs Corpus")) %>%
  kable_styling(bootstrap_options = c("striped", "hover"), full_width = FALSE) %>%
  scroll_box(height = "500px")
```

## Actor Type Topic Profiles

```{r actor-profiles}
#| label: actor-profiles
#| fig-height: 12
#| fig-width: 14

category_by_actor <- specialization_df %>%
  group_by(actor_type, Category) %>%
  summarise(Category_Proportion = sum(Proportion), .groups = "drop")

ggplot(category_by_actor, aes(x = Category, y = Category_Proportion, fill = Category)) +
  geom_col(width = 0.7) +
  facet_wrap(~actor_type, scales = "free_y", ncol = 3) +
  scale_fill_brewer(palette = "Set2") +
  scale_y_continuous(labels = function(x) paste0(round(x * 100, 1), "%")) +
  labs(
    title = "Thematic Category Profiles by Actor Type",
    subtitle = "What each actor type talks about",
    x = NULL,
    y = "Proportion of Content"
  ) +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1, size = 8),
    legend.position = "none",
    strip.text = element_text(face = "bold")
  )
```

# Analysis 2.4: Topic by Platform Mapping

How do topics vary across digital platforms?

```{r platform-topic-prep}
#| label: platform-topic-prep

platform_topic_means <- doc_meta %>%
  group_by(platform) %>%
  summarise(across(starts_with("Topic_"), mean, na.rm = TRUE), .groups = "drop")

platform_topic_long <- platform_topic_means %>%
  pivot_longer(cols = starts_with("Topic_"),
               names_to = "Topic",
               values_to = "Proportion") %>%
  mutate(Topic_Num = as.numeric(gsub("Topic_", "", Topic))) %>%
  left_join(topic_taxonomy %>% select(Topic, Category, Label) %>%
              rename(Topic_Num = Topic), by = "Topic_Num")
```

## Platform Topic Heatmap

```{r platform-topic-heatmap}
#| label: platform-topic-heatmap
#| fig-height: 8
#| fig-width: 12

platform_topic_matrix <- platform_topic_means %>%
  column_to_rownames("platform") %>%
  as.matrix()

colnames(platform_topic_matrix) <- 1:K

pheatmap(
  t(platform_topic_matrix) * 100,
  cluster_rows = TRUE,
  cluster_cols = TRUE,
  color = colorRampPalette(c("white", "#e07b39", "#c44536"))(100),
  main = "Topic Proportions by Platform (%)",
  fontsize = 10,
  fontsize_row = 8,
  fontsize_col = 10,
  angle_col = 45,
  display_numbers = FALSE,
  border_color = "grey90"
)
```

## Platform Category Profiles

```{r platform-profiles}
#| label: platform-profiles
#| fig-height: 8

category_by_platform <- platform_topic_long %>%
  group_by(platform, Category) %>%
  summarise(Category_Proportion = sum(Proportion), .groups = "drop")

ggplot(category_by_platform, aes(x = reorder(platform, Category_Proportion), 
                                  y = Category_Proportion, fill = Category)) +
  geom_col(position = "fill", width = 0.8) +
  coord_flip() +
  scale_fill_brewer(palette = "Set2") +
  scale_y_continuous(labels = percent) +
  labs(
    title = "Thematic Composition by Platform",
    subtitle = "Relative distribution of topic categories",
    x = NULL,
    y = "Proportion",
    fill = "Category"
  ) +
  theme(legend.position = "right")
```

## Platform Specialization

```{r platform-specialization}
#| label: platform-specialization
#| fig-height: 7

platform_spec <- platform_topic_long %>%
  left_join(tibble(Topic_Num = 1:K, Corpus_Avg = corpus_avg), by = "Topic_Num") %>%
  mutate(Lift = Proportion / Corpus_Avg) %>%
  group_by(platform) %>%
  slice_max(Lift, n = 5) %>%
  ungroup()

platform_spec %>%
  select(platform, Label, Category, Lift) %>%
  mutate(Lift = sprintf("%.2fx", Lift)) %>%
  arrange(platform, desc(as.numeric(gsub("x", "", Lift)))) %>%
  kable(col.names = c("Platform", "Topic", "Category", "Lift")) %>%
  kable_styling(bootstrap_options = c("striped", "hover"), full_width = FALSE) %>%
  scroll_box(height = "400px")
```

# Analysis 2.5: Topic Engagement Differential

Which topics generate more engagement?

```{r engagement-prep}
#| label: engagement-prep
doc_engagement <- dta_sample[, .(doc_id, INTERACTIONS, REACH)]

# Create row indices for joining
doc_meta_with_id <- doc_meta |>
  mutate(row_id = row_number())

doc_engagement_with_id <- doc_engagement |>
  mutate(row_id = row_number())

# Join by row_id since both datasets have same order
doc_meta_eng <- doc_meta_with_id |>
  left_join(doc_engagement_with_id, by = "row_id", suffix = c("", "_y"))

# Now proceed with topic engagement calculation
topic_engagement <- lapply(1:K, function(t) {
  topic_col <- paste0("Topic_", t)
  doc_meta_eng |>
    mutate(weight = .data[[topic_col]]) |>
    summarise(
      Topic = t,
      Weighted_Mean_Engagement = weighted.mean(INTERACTIONS, weight, na.rm = TRUE),
      Mean_Engagement = mean(INTERACTIONS[.data[[topic_col]] > 0.1], na.rm = TRUE),
      Total_Engagement = sum(INTERACTIONS * weight, na.rm = TRUE),
      Document_Count = sum(.data[[topic_col]] > 0.1)
    )
}) |> bind_rows()

topic_engagement <- topic_engagement |>
  left_join(topic_taxonomy, by = "Topic") |>
  left_join(topic_prev_df |> 
              mutate(Topic = as.numeric(as.character(Topic))), by = "Topic")
```

## Topic Engagement Ranking

```{r topic-engagement-chart}
#| label: topic-engagement-chart
#| fig-height: 10

ggplot(topic_engagement, aes(x = reorder(factor(Topic), Weighted_Mean_Engagement),
                              y = Weighted_Mean_Engagement, fill = Category)) +
  geom_col(width = 0.7) +
  geom_text(aes(label = round(Weighted_Mean_Engagement, 0)), 
            hjust = -0.1, size = 3) +
  coord_flip() +
  scale_fill_brewer(palette = "Set2") +
  scale_y_continuous(limits = c(0, max(topic_engagement$Weighted_Mean_Engagement, na.rm = TRUE) * 1.15)) +
  labs(
    title = "Average Engagement by Topic",
    subtitle = "Weighted mean interactions per document",
    x = "Topic",
    y = "Weighted Mean Engagement",
    fill = "Category"
  )
```

## Volume vs Engagement Comparison

```{r volume-vs-engagement}
#| label: volume-vs-engagement
#| fig-height: 8

topic_engagement <- topic_engagement %>%
  mutate(
    Prevalence_Rank = rank(-Prevalence),
    Engagement_Rank = rank(-Weighted_Mean_Engagement),
    Engagement_Efficiency = Engagement_Rank - Prevalence_Rank
  )

ggplot(topic_engagement, aes(x = Prevalence, y = Weighted_Mean_Engagement)) +
  geom_point(aes(color = Category, size = Total_Engagement), alpha = 0.7) +
  geom_text_repel(aes(label = Topic), size = 3, max.overlaps = 15) +
  geom_smooth(method = "lm", se = TRUE, linetype = "dashed", color = "gray50") +
  scale_color_brewer(palette = "Set2") +
  scale_size_continuous(range = c(3, 12), labels = comma) +
  labs(
    title = "Topic Prevalence vs Engagement",
    subtitle = "Points above the trend line are engagement overperformers",
    x = "Prevalence (%)",
    y = "Weighted Mean Engagement",
    color = "Category",
    size = "Total Engagement"
  )
```

## Engagement Efficiency by Category

```{r category-engagement}
#| label: category-engagement
#| fig-height: 6

category_engagement <- topic_engagement %>%
  group_by(Category) %>%
  summarise(
    Mean_Engagement = mean(Weighted_Mean_Engagement, na.rm = TRUE),
    Total_Prevalence = sum(Prevalence),
    Engagement_per_Prevalence = Mean_Engagement / Total_Prevalence,
    .groups = "drop"
  ) %>%
  arrange(desc(Engagement_per_Prevalence))

ggplot(category_engagement, aes(x = Total_Prevalence, y = Mean_Engagement)) +
  geom_point(aes(color = Category), size = 8) +
  geom_text_repel(aes(label = Category), size = 4) +
  scale_color_brewer(palette = "Set2") +
  labs(
    title = "Category Prevalence vs Engagement",
    subtitle = "Which thematic categories punch above their weight?",
    x = "Total Prevalence (%)",
    y = "Mean Engagement per Topic"
  ) +
  theme(legend.position = "none")
```

::: {.callout-important}
## Key Finding on Engagement Differential
Topics in the Political and Social/Ethical categories often generate disproportionately high engagement relative to their prevalence, supporting the hypothesis that controversial content attracts more attention.
:::

# Analysis 2.6: Temporal Topic Trends

How do topics evolve over time?

```{r temporal-topics}
#| label: temporal-topics
#| fig-height: 10

yearly_topics <- doc_meta %>%
  group_by(year) %>%
  summarise(across(starts_with("Topic_"), mean, na.rm = TRUE), .groups = "drop") %>%
  pivot_longer(cols = starts_with("Topic_"),
               names_to = "Topic",
               values_to = "Proportion") %>%
  mutate(Topic_Num = as.numeric(gsub("Topic_", "", Topic))) %>%
  left_join(topic_taxonomy %>% select(Topic, Category) %>%
              rename(Topic_Num = Topic), by = "Topic_Num")

category_yearly <- yearly_topics %>%
  group_by(year, Category) %>%
  summarise(Proportion = sum(Proportion), .groups = "drop")

ggplot(category_yearly, aes(x = year, y = Proportion, fill = Category)) +
  geom_area(alpha = 0.8) +
  scale_fill_brewer(palette = "Set2") +
  scale_y_continuous(labels = percent) +
  labs(
    title = "Thematic Evolution Over Time",
    subtitle = "Category proportions by year",
    x = "Year",
    y = "Proportion",
    fill = "Category"
  )
```

## Top Growing and Declining Topics

```{r topic-trends}
#| label: topic-trends

yearly_wide <- doc_meta %>%
  group_by(year) %>%
  summarise(across(starts_with("Topic_"), mean, na.rm = TRUE), .groups = "drop")

if (nrow(yearly_wide) >= 2) {
  first_year <- yearly_wide$year[1]
  last_year <- yearly_wide$year[nrow(yearly_wide)]
  
  topic_trends <- data.frame(
    Topic = 1:K,
    Start = as.numeric(yearly_wide[1, paste0("Topic_", 1:K)]),
    End = as.numeric(yearly_wide[nrow(yearly_wide), paste0("Topic_", 1:K)])
  ) %>%
    mutate(
      Change = End - Start,
      Pct_Change = (End - Start) / Start * 100
    ) %>%
    left_join(topic_taxonomy, by = "Topic") %>%
    arrange(desc(Change))
  
  cat("Top 5 Growing Topics:\n")
  print(head(topic_trends %>% select(Topic, Label, Category, Change, Pct_Change), 5))
  
  cat("\nTop 5 Declining Topics:\n")
  print(tail(topic_trends %>% select(Topic, Label, Category, Change, Pct_Change), 5))
}
```

# Summary and Key Findings

```{r summary-stats}
#| label: summary-stats

# Debug: show what we have
cat("category_prevalence columns:", paste(names(category_prevalence), collapse = ", "), "\n")
cat("category_engagement columns:", paste(names(category_engagement), collapse = ", "), "\n")

# Join category data
category_summary <- category_prevalence %>%
  left_join(category_engagement, by = "Category")

cat("category_summary columns:", paste(names(category_summary), collapse = ", "), "\n")
cat("category_summary rows:", nrow(category_summary), "\n")

# Get top category by prevalence (handle if column missing)
if ("Total_Prevalence" %in% names(category_summary)) {
  top_category <- category_summary %>% 
    filter(!is.na(Total_Prevalence)) %>%
    slice_max(Total_Prevalence, n = 1)
  top_cat_name <- top_category$Category[1]
  top_cat_prev <- round(top_category$Total_Prevalence[1], 1)
} else {
  top_cat_name <- "Unknown"
  top_cat_prev <- 0
}

# Get top category by engagement  
if ("Mean_Engagement" %in% names(category_summary)) {
  top_engagement_cat <- category_summary %>% 
    filter(!is.na(Mean_Engagement)) %>%
    slice_max(Mean_Engagement, n = 1)
  top_eng_cat_name <- top_engagement_cat$Category[1]
} else {
  top_eng_cat_name <- "Unknown"
}

cat("Top category:", top_cat_name, "with", top_cat_prev, "% prevalence\n")
cat("Top engagement category:", top_eng_cat_name, "\n")
```

## Thematic Structure Findings

1. **Dominant themes:** The corpus is dominated by `r top_cat_name` content (`r top_cat_prev`% prevalence)

2. **Engagement patterns:** `r top_eng_cat_name` content generates the highest average engagement despite not being the most prevalent

3. **Actor specialization:** Clear patterns emerge in what different actors talk about
   
4. **Platform differences:** Web platforms show more institutional/news content while social platforms show more devotional and community content

## Topic Model Summary Table

```{r final-summary}
#| label: final-summary

topic_engagement %>%
  select(Topic, Label, Category, Prevalence, Weighted_Mean_Engagement) %>%
  arrange(desc(Prevalence)) %>%
  head(15) %>%
  mutate(
    Prevalence = sprintf("%.1f%%", Prevalence),
    Weighted_Mean_Engagement = round(Weighted_Mean_Engagement, 0)
  ) %>%
  kable(col.names = c("Topic", "Label", "Category", "Prevalence", "Mean Engagement")) %>%
  kable_styling(bootstrap_options = c("striped", "hover"), full_width = FALSE)
```

## Hypotheses Testing Summary

| Hypothesis | Finding |
|------------|---------|
| H7: Devotional/liturgical content dominates volume | Examine category prevalence results above |
| H8: Political/social content generates disproportionate engagement | Compare engagement efficiency by category |
| H9: Individual priests concentrate on social/political topics | See actor specialization patterns |

---

# Appendix: Model Diagnostics

```{r model-diagnostics}
#| label: model-diagnostics

cat("Topic Model Summary:\n")
cat("Number of topics:", K, "\n")
cat("Documents:", nrow(doc_topics), "\n")
cat("Vocabulary size:", length(stm_model$vocab), "\n")
```

```{r session-info}
#| label: session-info

sessionInfo()
```
